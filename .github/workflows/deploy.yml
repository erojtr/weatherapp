name: Deploy WeatherApp to EC2

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd weatherapp
            git pull origin main
            npm install --production=false
            npx tsc
            pm2 restart weatherapp || pm2 start "npx tsx app.ts" --name weatherapp

      # --- (Optional) Your existing SDLC deployment event via curl (fixed) ---
      - name: Send SDLC Deployment Event to Dynatrace (curl)
        env:
          DT_SDLCE_URL: ${{ secrets.DT_SDLCE_URL }}
          DT_API_TOKEN: ${{ secrets.DT_API_TOKEN }}
        run: |
          SHA_SHORT="${GITHUB_SHA::7}"
          BRANCH="${GITHUB_REF_NAME}"
          ACTOR="${GITHUB_ACTOR}"
          APP="weatherapp"
          ENVIRONMENT="prod"

          cat > payload.json <<EOF
          {
            "event.type": "deployment",
            "event.status": "finished",
            "app.name": "$APP",
            "app.env": "$ENVIRONMENT",
            "git.commit": "$SHA_SHORT",
            "git.branch": "$BRANCH",
            "ci.actor": "$ACTOR",
            "ci.system": "github-actions"
          }
          EOF

          curl -sS -X POST "$DT_SDLCE_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Api-Token $DT_API_TOKEN" \
            --data @payload.json

      # --- âœ… Requested block added as its own step (recommended placement) ---
      - name: Send deployment event to Dynatrace
        uses: dynatrace-oss/dynatrace-github-action@v9
        with:
          url: ${{ secrets.DT_EVENTS_URL }}
          token: ${{ secrets.DT_API_TOKEN }}
          events: |
            - title: My Application Deployment
              type: CUSTOM_DEPLOYMENT
              entitySelector: type(SERVICE),entityName(dynatrace-weather-app) # Select the relevant entity (e.g., host, service)
              properties:
                source: GitHub Actions
                description: A new version of the application was deployed
                github.repository: "${{ github.repository }}"
                github.actor: "${{ github.actor }}"
                github.sha: "${{ github.sha }}"
                version: "1.0.0" # Example property
